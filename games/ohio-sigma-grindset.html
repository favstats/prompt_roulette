<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHIO SIGMA GRINDSET - Escape the Brainrot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2a 50%, #0a1a0a 100%);
            font-family: 'Impact', 'Arial Black', sans-serif;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(255, 0, 100, 0.3), 0 0 100px rgba(0, 255, 255, 0.2);
        }
        canvas {
            display: block;
            border-radius: 8px;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 8px;
            z-index: 100;
            padding: 20px;
            text-align: center;
        }
        #overlay.hidden {
            display: none;
        }
        .title {
            font-size: 2.8em;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #ff0066, #00ffff, #ff0066);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
        }
        @keyframes shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .subtitle {
            font-size: 1.3em;
            color: #ff6600;
            margin-bottom: 20px;
            font-style: italic;
        }
        .instructions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            width: 100%;
            max-width: 800px;
        }
        .npc-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid;
            border-radius: 10px;
            padding: 12px;
        }
        .npc-card.skibidi { border-color: #ff0066; }
        .npc-card.rizz { border-color: #ff00ff; }
        .npc-card.gyatt { border-color: #ffaa00; }
        .npc-card.ohio { border-color: #00ff00; }
        .npc-card h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .npc-card p {
            font-size: 0.85em;
            color: #aaa;
            font-family: Arial, sans-serif;
        }
        .controls-box {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 15px 25px;
            margin: 15px 0;
        }
        .controls-box h3 {
            color: #00ffff;
            margin-bottom: 10px;
        }
        .key {
            display: inline-block;
            background: linear-gradient(180deg, #333 0%, #111 100%);
            padding: 5px 12px;
            border-radius: 5px;
            margin: 3px;
            border: 2px solid #555;
            font-weight: bold;
        }
        .key.move { border-color: #00ff00; color: #00ff00; }
        .key.action { border-color: #ff0066; color: #ff0066; }
        #start-btn, #restart-btn {
            background: linear-gradient(180deg, #ff0066 0%, #aa0044 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.4em;
            font-family: 'Impact', sans-serif;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 5px 0 #660022, 0 0 30px rgba(255, 0, 102, 0.5);
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #start-btn:hover, #restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #660022, 0 0 50px rgba(255, 0, 102, 0.7);
        }
        #start-btn:active, #restart-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #660022;
        }
        #help-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ffff;
            border: 2px solid #00ffff;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Impact', sans-serif;
            z-index: 50;
        }
        .warning {
            color: #ff6600;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .result-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }
        .stats {
            font-size: 1.2em;
            color: #00ffff;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="overlay">
            <div class="title">üóø OHIO SIGMA GRINDSET üóø</div>
            <div class="subtitle">Escape the Brainrot - Navigate the Chaos</div>
            
            <div class="instructions-grid">
                <div class="npc-card skibidi">
                    <h3>üöΩ SKIBIDI</h3>
                    <p>Erratic dancers. Use <strong>MOG</strong> to assert dominance!</p>
                </div>
                <div class="npc-card rizz">
                    <h3>üíã RIZZ</h3>
                    <p>Trying to charm you. <strong>IGNORE</strong> their advances!</p>
                </div>
                <div class="npc-card gyatt">
                    <h3>üçë GYATT</h3>
                    <p>Creates shockwaves. <strong>GRIND</strong> right through!</p>
                </div>
            </div>
            
            <div class="controls-box">
                <h3>‚å®Ô∏è SIGMA CONTROLS</h3>
                <p>
                    <span class="key move">WASD</span> or <span class="key move">ARROWS</span> Move
                    &nbsp;‚Ä¢&nbsp;
                    <span class="key action">1</span> MOG
                    &nbsp;
                    <span class="key action">2</span> IGNORE  
                    &nbsp;
                    <span class="key action">3</span> GRIND
                </p>
                <p style="margin-top: 8px; color: #aaa; font-family: Arial;">
                    Reach the EXIT üö™ on each level! Use the RIGHT action on each NPC type!
                </p>
            </div>
            
            <p class="warning">‚ö†Ô∏è WRONG ACTION = LOSE A LIFE ‚Ä¢ 3 LIVES TOTAL ‚ö†Ô∏è</p>
            
            <button id="start-btn">üî• START GRINDING üî•</button>
        </div>
        <button id="help-btn" class="hidden">‚ùì HELP</button>
    </div>

    <script>
        // ===== GAME CONSTANTS =====
        const GAME_WIDTH = 900;
        const GAME_HEIGHT = 650;
        const TILE_SIZE = 50;
        const PLAYER_SPEED = 4;
        
        // ===== GAME STATE =====
        let gameState = 'menu';
        let currentLevel = 0;
        let lives = 3;
        let score = 0;
        let player;
        let npcs = [];
        let exit;
        let particles = [];
        let floatingTexts = [];
        let currentAction = null;
        let actionTimer = 0;
        let screenShake = 0;
        let levelTransition = 0;
        let sigmaLevel = 0;
        
        // ===== AUDIO CONTEXT FOR SIGMA MUSIC =====
        let audioCtx;
        let isPlaying = false;
        let bassOsc, leadOsc, hihatGain;
        let beatCount = 0;
        
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Master gain
            const masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.3;
            masterGain.connect(audioCtx.destination);
            
            // Bass oscillator
            bassOsc = audioCtx.createOscillator();
            bassOsc.type = 'sawtooth';
            bassOsc.frequency.value = 55;
            const bassGain = audioCtx.createGain();
            bassGain.gain.value = 0.4;
            const bassFilter = audioCtx.createBiquadFilter();
            bassFilter.type = 'lowpass';
            bassFilter.frequency.value = 200;
            bassOsc.connect(bassFilter);
            bassFilter.connect(bassGain);
            bassGain.connect(masterGain);
            
            // Lead oscillator
            leadOsc = audioCtx.createOscillator();
            leadOsc.type = 'square';
            leadOsc.frequency.value = 220;
            const leadGain = audioCtx.createGain();
            leadGain.gain.value = 0.15;
            leadOsc.connect(leadGain);
            leadGain.connect(masterGain);
            
            // Start oscillators
            bassOsc.start();
            leadOsc.start();
            
            isPlaying = true;
            
            // Sigma beat pattern
            setInterval(() => {
                if (!isPlaying || gameState === 'menu') return;
                
                const now = audioCtx.currentTime;
                const bassNotes = [55, 55, 73.4, 55, 82.4, 55, 73.4, 55];
                const leadNotes = [220, 0, 293.7, 0, 349.2, 329.6, 293.7, 0];
                
                bassOsc.frequency.setValueAtTime(bassNotes[beatCount % 8], now);
                if (leadNotes[beatCount % 8] > 0) {
                    leadOsc.frequency.setValueAtTime(leadNotes[beatCount % 8], now);
                }
                
                beatCount++;
            }, 180);
        }
        
        // ===== LEVELS =====
        const LEVELS = [
            {
                name: "WELCOME TO OHIO",
                layout: [
                    "##################",
                    "#P               #",
                    "#                #",
                    "#     S          #",
                    "#                #",
                    "#               E#",
                    "##################"
                ],
                tutorial: "Use MOG (1) on Skibidi!"
            },
            {
                name: "RIZZ CHECK",
                layout: [
                    "##################",
                    "#P       R       #",
                    "#                #",
                    "#   R       R    #",
                    "#                #",
                    "#        R      E#",
                    "##################"
                ],
                tutorial: "IGNORE (2) the Rizz!"
            },
            {
                name: "GYATT DAMN",
                layout: [
                    "##################",
                    "#P               #",
                    "#     G          #",
                    "#          G     #",
                    "#     G          #",
                    "#               E#",
                    "##################"
                ],
                tutorial: "GRIND (3) through Gyatt!"
            },
            {
                name: "OHIO CHAOS",
                layout: [
                    "##################",
                    "#P   S     R     #",
                    "#                #",
                    "# G    S    G    #",
                    "#       R        #",
                    "#  S       R    E#",
                    "##################"
                ],
                tutorial: "Mix it up! Remember your moves!"
            },
            {
                name: "FINAL GRIND",
                layout: [
                    "##################",
                    "#P S  R  G  S  R #",
                    "#                #",
                    "# G  S  R  G  S  #",
                    "#                #",
                    "# R  G  S  R  G E#",
                    "##################"
                ],
                tutorial: "ULTIMATE SIGMA TEST!"
            }
        ];
        
        // ===== CLASSES =====
        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = 40;
                this.vx = 0;
                this.vy = 0;
                this.bobOffset = 0;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.bobOffset += 0.15;
                
                // Wall collision (adjusted for level bounds)
                this.x = constrain(this.x, TILE_SIZE, GAME_WIDTH - TILE_SIZE - this.size);
                this.y = constrain(this.y, TILE_SIZE + 70, GAME_HEIGHT - TILE_SIZE);
            }
            
            draw() {
                push();
                translate(this.x + this.size/2, this.y + this.size/2);
                let bob = sin(this.bobOffset) * 3;
                translate(0, bob);
                
                // Sigma glow when action active
                if (actionTimer > 0) {
                    let glowColor;
                    if (currentAction === 'mog') glowColor = color(255, 0, 102, 100);
                    else if (currentAction === 'ignore') glowColor = color(0, 255, 255, 100);
                    else if (currentAction === 'grind') glowColor = color(255, 170, 0, 100);
                    
                    fill(glowColor);
                    noStroke();
                    ellipse(0, 0, this.size + 30 + sin(frameCount * 0.3) * 10);
                }
                
                // Body
                fill(50, 50, 50);
                stroke(0);
                strokeWeight(2);
                ellipse(0, 0, this.size, this.size);
                
                // Sigma face üóø
                fill(180, 160, 140);
                noStroke();
                ellipse(0, -2, 30, 35);
                
                // Eyes (determined sigma stare)
                fill(0);
                rect(-8, -8, 6, 4);
                rect(2, -8, 6, 4);
                
                // Strong jaw
                fill(160, 140, 120);
                beginShape();
                vertex(-10, 5);
                vertex(0, 15);
                vertex(10, 5);
                endShape(CLOSE);
                
                // Action indicator
                if (actionTimer > 0) {
                    fill(255);
                    textSize(14);
                    textAlign(CENTER, CENTER);
                    let actionText = currentAction.toUpperCase();
                    text(actionText, 0, -35);
                }
                
                pop();
            }
        }
        
        class NPC {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.size = 45;
                this.phase = random(TWO_PI);
                this.defeated = false;
                this.defeatTimer = 0;
                this.alertLevel = 0;
            }
            
            getWeakness() {
                if (this.type === 'skibidi') return 'mog';
                if (this.type === 'rizz') return 'ignore';
                if (this.type === 'gyatt') return 'grind';
                return null;
            }
            
            update() {
                if (this.defeated) {
                    this.defeatTimer++;
                    return this.defeatTimer > 30;
                }
                
                this.phase += 0.05;
                
                // Different movement patterns
                if (this.type === 'skibidi') {
                    this.x += sin(this.phase * 3) * 2;
                    this.y += cos(this.phase * 2) * 1;
                } else if (this.type === 'rizz') {
                    // Moves toward player slowly
                    let dx = player.x - this.x;
                    let dy = player.y - this.y;
                    let dist = sqrt(dx*dx + dy*dy);
                    if (dist > 100) {
                        this.x += (dx / dist) * 0.5;
                        this.y += (dy / dist) * 0.5;
                    }
                } else if (this.type === 'gyatt') {
                    this.y += sin(this.phase) * 0.5;
                }
                
                // Check proximity to player
                let dist = dist2D(this.x, this.y, player.x, player.y);
                if (dist < 80) {
                    this.alertLevel = min(1, this.alertLevel + 0.05);
                } else {
                    this.alertLevel = max(0, this.alertLevel - 0.02);
                }
                
                return false;
            }
            
            draw() {
                push();
                translate(this.x + this.size/2, this.y + this.size/2);
                
                if (this.defeated) {
                    let alpha = map(this.defeatTimer, 0, 30, 255, 0);
                    let scl = map(this.defeatTimer, 0, 30, 1, 1.5);
                    this.drawNPC(alpha, scl);
                } else {
                    // Alert indicator
                    if (this.alertLevel > 0) {
                        noFill();
                        stroke(255, 0, 0, this.alertLevel * 200);
                        strokeWeight(3);
                        ellipse(0, 0, this.size + 20 + sin(frameCount * 0.3) * 5);
                    }
                    this.drawNPC(255, 1);
                }
                
                pop();
            }
            
            drawNPC(alpha, scl) {
                push();
                scale(scl);
                
                if (this.type === 'skibidi') {
                    // Skibidi toilet
                    let wobble = sin(this.phase * 5) * 10;
                    rotate(radians(wobble));
                    
                    // Toilet base
                    fill(240, 240, 240, alpha);
                    stroke(0, alpha);
                    strokeWeight(2);
                    ellipse(0, 10, 40, 25);
                    rect(-15, -5, 30, 20, 5);
                    
                    // Head
                    fill(255, 200, 180, alpha);
                    ellipse(0, -15, 30, 30);
                    
                    // Eyes (spiral crazy)
                    fill(0, alpha);
                    ellipse(-6, -18, 8, 8);
                    ellipse(6, -18, 8, 8);
                    fill(255, alpha);
                    ellipse(-6 + sin(this.phase * 3) * 2, -18, 3, 3);
                    ellipse(6 + sin(this.phase * 3) * 2, -18, 3, 3);
                    
                    // Mouth
                    fill(0, alpha);
                    ellipse(0, -8, 12, 8);
                    
                } else if (this.type === 'rizz') {
                    // Rizz character
                    let charm = sin(this.phase * 2) * 5;
                    
                    // Body
                    fill(255, 100, 200, alpha);
                    stroke(0, alpha);
                    strokeWeight(2);
                    ellipse(0, 5, 35, 40);
                    
                    // Face
                    fill(255, 220, 200, alpha);
                    ellipse(0, -10, 30, 30);
                    
                    // Rizz eyes (heart shaped)
                    fill(255, 0, 100, alpha);
                    textSize(12);
                    noStroke();
                    text("‚ô•", -8, -8);
                    text("‚ô•", 4, -8);
                    
                    // Smirk
                    noFill();
                    stroke(0, alpha);
                    strokeWeight(2);
                    arc(0, -3, 15, 10, 0.2, PI - 0.2);
                    
                    // Sparkles
                    fill(255, 255, 0, alpha * abs(sin(this.phase * 3)));
                    noStroke();
                    textSize(15);
                    text("‚ú®", 18 + charm, -20);
                    text("‚ú®", -25 + charm, -15);
                    
                } else if (this.type === 'gyatt') {
                    // Gyatt (thicc energy)
                    let pulse = sin(this.phase * 2) * 3;
                    
                    // Shockwave rings
                    noFill();
                    stroke(255, 170, 0, alpha * 0.3);
                    strokeWeight(3);
                    ellipse(0, 0, 60 + pulse * 3, 60 + pulse * 3);
                    ellipse(0, 0, 80 + pulse * 3, 80 + pulse * 3);
                    
                    // Body
                    fill(255, 170, 0, alpha);
                    stroke(0, alpha);
                    strokeWeight(2);
                    ellipse(0, 5, 45 + pulse, 50 + pulse);
                    
                    // Face
                    fill(255, 220, 200, alpha);
                    ellipse(0, -10, 28, 28);
                    
                    // Sunglasses
                    fill(0, alpha);
                    noStroke();
                    rect(-12, -14, 10, 7, 2);
                    rect(2, -14, 10, 7, 2);
                    rect(-2, -12, 4, 3);
                    
                    // Mouth
                    stroke(0, alpha);
                    noFill();
                    arc(0, -4, 10, 8, 0, PI);
                    
                    // GYATT text
                    fill(255, 100, 0, alpha);
                    noStroke();
                    textSize(10);
                    textAlign(CENTER);
                    text("GYATT", 0, 30);
                }
                
                pop();
            }
            
            checkCollision(px, py) {
                if (this.defeated) return false;
                let d = dist2D(this.x + this.size/2, this.y + this.size/2, px + player.size/2, py + player.size/2);
                return d < (this.size + player.size) / 2 - 10;
            }
        }
        
        class Particle {
            constructor(x, y, color, emoji = null) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.emoji = emoji;
                this.vx = random(-4, 4);
                this.vy = random(-6, -2);
                this.life = 40;
                this.maxLife = 40;
                this.size = random(8, 20);
                this.rotation = random(TWO_PI);
                this.rotSpeed = random(-0.2, 0.2);
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.2;
                this.rotation += this.rotSpeed;
                this.life--;
                return this.life <= 0;
            }
            
            draw() {
                let alpha = (this.life / this.maxLife) * 255;
                push();
                translate(this.x, this.y);
                rotate(this.rotation);
                
                if (this.emoji) {
                    textSize(this.size);
                    textAlign(CENTER, CENTER);
                    text(this.emoji, 0, 0);
                } else {
                    noStroke();
                    fill(red(this.color), green(this.color), blue(this.color), alpha);
                    ellipse(0, 0, this.size);
                }
                pop();
            }
        }
        
        class FloatingText {
            constructor(x, y, text, color, size = 24) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.size = size;
                this.life = 50;
                this.maxLife = 50;
            }
            
            update() {
                this.y -= 1.5;
                this.life--;
                return this.life <= 0;
            }
            
            draw() {
                let alpha = (this.life / this.maxLife) * 255;
                let scl = map(this.life, this.maxLife, 0, 1, 1.3);
                push();
                translate(this.x, this.y);
                scale(scl);
                textSize(this.size);
                textAlign(CENTER, CENTER);
                fill(red(this.color), green(this.color), blue(this.color), alpha);
                stroke(0, alpha);
                strokeWeight(3);
                text(this.text, 0, 0);
                pop();
            }
        }
        
        // ===== HELPER FUNCTIONS =====
        function dist2D(x1, y1, x2, y2) {
            return sqrt((x2-x1)**2 + (y2-y1)**2);
        }
        
        function loadLevel(levelIndex) {
            npcs = [];
            particles = [];
            floatingTexts = [];
            exit = null;
            
            let level = LEVELS[levelIndex];
            let layout = level.layout;
            
            for (let row = 0; row < layout.length; row++) {
                for (let col = 0; col < layout[row].length; col++) {
                    let char = layout[row][col];
                    let x = col * TILE_SIZE;
                    let y = row * TILE_SIZE + 70;
                    
                    if (char === 'P') {
                        player = new Player(x + 5, y + 5);
                    } else if (char === 'S') {
                        npcs.push(new NPC(x, y, 'skibidi'));
                    } else if (char === 'R') {
                        npcs.push(new NPC(x, y, 'rizz'));
                    } else if (char === 'G') {
                        npcs.push(new NPC(x, y, 'gyatt'));
                    } else if (char === 'E') {
                        exit = { x: x, y: y };
                    }
                }
            }
            
            levelTransition = 60;
        }
        
        // ===== P5.JS SETUP =====
        function setup() {
            let canvas = createCanvas(GAME_WIDTH, GAME_HEIGHT);
            canvas.parent('game-container');
            textFont('Impact, Arial Black, sans-serif');
            
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('help-btn').addEventListener('click', showHelp);
        }
        
        function startGame() {
            initAudio();
            gameState = 'playing';
            currentLevel = 0;
            lives = 3;
            score = 0;
            sigmaLevel = 0;
            loadLevel(0);
            
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('help-btn').classList.remove('hidden');
        }
        
        function showHelp() {
            gameState = 'paused';
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('start-btn').textContent = 'üî• RESUME üî•';
        }
        
        function showEndScreen(won) {
            gameState = 'end';
            let overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden');
            document.getElementById('help-btn').classList.add('hidden');
            
            if (won) {
                overlay.innerHTML = `
                    <div class="result-icon">üóøüëë</div>
                    <div class="title">ULTIMATE SIGMA</div>
                    <div class="subtitle">You've escaped Ohio!</div>
                    <div class="stats">
                        üíØ Sigma Level: ${sigmaLevel}<br>
                        ‚ù§Ô∏è Lives Remaining: ${lives}<br>
                        üèÜ TRUE GRINDSET ACHIEVED
                    </div>
                    <p style="color: #aaa;">The grind never stops... but you've earned a break.</p>
                    <button id="restart-btn" onclick="location.reload()">üî• GRIND AGAIN üî•</button>
                `;
            } else {
                overlay.innerHTML = `
                    <div class="result-icon">üíÄ</div>
                    <div class="title" style="color: #ff0000;">SKILL ISSUE</div>
                    <div class="subtitle">Ohio claimed another victim...</div>
                    <div class="stats">
                        üìä Level Reached: ${currentLevel + 1}/5<br>
                        üíØ Sigma Level: ${sigmaLevel}<br>
                        üòî Not Sigma Enough
                    </div>
                    <p style="color: #aaa;">The grind demands more dedication.</p>
                    <button id="restart-btn" onclick="location.reload()">üî• TRY AGAIN üî•</button>
                `;
            }
        }
        
        // ===== MAIN DRAW LOOP =====
        function draw() {
            if (gameState === 'menu' || gameState === 'paused') {
                drawGame();
                return;
            }
            
            if (gameState === 'playing') {
                updateGame();
            }
            
            drawGame();
        }
        
        function updateGame() {
            // Handle input
            player.vx = 0;
            player.vy = 0;
            
            if (keyIsDown(LEFT_ARROW) || keyIsDown(65)) player.vx = -PLAYER_SPEED;
            if (keyIsDown(RIGHT_ARROW) || keyIsDown(68)) player.vx = PLAYER_SPEED;
            if (keyIsDown(UP_ARROW) || keyIsDown(87)) player.vy = -PLAYER_SPEED;
            if (keyIsDown(DOWN_ARROW) || keyIsDown(83)) player.vy = PLAYER_SPEED;
            
            // Normalize diagonal movement
            if (player.vx !== 0 && player.vy !== 0) {
                player.vx *= 0.707;
                player.vy *= 0.707;
            }
            
            player.update();
            
            // Update action timer
            if (actionTimer > 0) actionTimer--;
            
            // Update NPCs
            for (let i = npcs.length - 1; i >= 0; i--) {
                let npc = npcs[i];
                let shouldRemove = npc.update();
                
                if (shouldRemove) {
                    npcs.splice(i, 1);
                    continue;
                }
                
                // Check collision with player
                if (npc.checkCollision(player.x, player.y)) {
                    if (actionTimer > 0 && currentAction === npc.getWeakness()) {
                        // Correct action!
                        npc.defeated = true;
                        score += 100;
                        sigmaLevel++;
                        screenShake = 10;
                        
                        // Particles
                        for (let j = 0; j < 15; j++) {
                            let emojis = ['üî•', 'üíØ', 'üóø', '‚ú®'];
                            particles.push(new Particle(npc.x + npc.size/2, npc.y + npc.size/2, 
                                color(255, 200, 0), random(emojis)));
                        }
                        
                        floatingTexts.push(new FloatingText(npc.x + npc.size/2, npc.y, 
                            "SIGMA!", color(255, 200, 0), 28));
                        
                    } else if (actionTimer > 0) {
                        // Wrong action!
                        loseLife("WRONG MOVE!");
                    } else {
                        // No action - damage
                        loseLife("USE AN ACTION!");
                    }
                }
            }
            
            // Check exit
            if (exit) {
                let d = dist2D(player.x + player.size/2, player.y + player.size/2, 
                               exit.x + TILE_SIZE/2, exit.y + TILE_SIZE/2);
                if (d < 40 && npcs.filter(n => !n.defeated).length === 0) {
                    currentLevel++;
                    if (currentLevel >= LEVELS.length) {
                        showEndScreen(true);
                    } else {
                        loadLevel(currentLevel);
                    }
                }
            }
            
            // Update particles
            for (let i = particles.length - 1; i >= 0; i--) {
                if (particles[i].update()) particles.splice(i, 1);
            }
            
            // Update floating texts
            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                if (floatingTexts[i].update()) floatingTexts.splice(i, 1);
            }
            
            // Decay screen shake
            screenShake *= 0.9;
            
            // Level transition
            if (levelTransition > 0) levelTransition--;
        }
        
        function loseLife(reason) {
            lives--;
            screenShake = 15;
            
            floatingTexts.push(new FloatingText(player.x + player.size/2, player.y - 30, 
                reason, color(255, 50, 50), 20));
            
            for (let i = 0; i < 10; i++) {
                particles.push(new Particle(player.x + player.size/2, player.y + player.size/2, 
                    color(255, 0, 0)));
            }
            
            // Reset NPCs (this also resets player position)
            loadLevel(currentLevel);
            
            if (lives <= 0) {
                showEndScreen(false);
            }
        }
        
        function drawGame() {
            push();
            
            // Screen shake
            if (screenShake > 0.5) {
                translate(random(-screenShake, screenShake), random(-screenShake, screenShake));
            }
            
            // Background
            drawBackground();
            
            // Exit
            if (exit) {
                drawExit();
            }
            
            // NPCs
            for (let npc of npcs) {
                npc.draw();
            }
            
            // Player
            if (player) {
                player.draw();
            }
            
            // Particles
            for (let p of particles) {
                p.draw();
            }
            
            // Floating texts
            for (let ft of floatingTexts) {
                ft.draw();
            }
            
            pop();
            
            // UI (not affected by shake)
            drawUI();
            
            // Level transition overlay
            if (levelTransition > 0) {
                fill(0, 0, 0, map(levelTransition, 0, 60, 0, 200));
                noStroke();
                rect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                
                if (levelTransition > 30) {
                    fill(255);
                    textSize(32);
                    textAlign(CENTER, CENTER);
                    text(LEVELS[currentLevel].name, GAME_WIDTH/2, GAME_HEIGHT/2 - 20);
                    textSize(18);
                    fill(200);
                    text(LEVELS[currentLevel].tutorial, GAME_WIDTH/2, GAME_HEIGHT/2 + 20);
                }
            }
        }
        
        function drawBackground() {
            // Ohio sky gradient (cursed)
            for (let y = 0; y < GAME_HEIGHT; y += 5) {
                let inter = map(y, 0, GAME_HEIGHT, 0, 1);
                let c = lerpColor(color(30, 10, 40), color(10, 20, 15), inter);
                noStroke();
                fill(c);
                rect(0, y, GAME_WIDTH, 5);
            }
            
            // Grid floor
            stroke(50, 50, 70, 100);
            strokeWeight(1);
            for (let x = 0; x < GAME_WIDTH; x += TILE_SIZE) {
                line(x, 70, x, GAME_HEIGHT);
            }
            for (let y = 70; y < GAME_HEIGHT; y += TILE_SIZE) {
                line(0, y, GAME_WIDTH, y);
            }
            
            // Ohio text watermark
            fill(255, 255, 255, 10);
            noStroke();
            textSize(120);
            textAlign(CENTER, CENTER);
            text("OHIO", GAME_WIDTH/2, GAME_HEIGHT/2 + 50);
            
            // Random floating meme text
            fill(255, 255, 255, 20 + sin(frameCount * 0.02) * 10);
            textSize(16);
            let memes = ["SKIBIDI", "RIZZ", "GYATT", "SIGMA", "OHIO", "üóø", "üíÄ", "NO CAP"];
            for (let i = 0; i < 5; i++) {
                let x = (frameCount * 0.5 + i * 200) % (GAME_WIDTH + 100) - 50;
                let y = 150 + i * 100 + sin(frameCount * 0.01 + i) * 20;
                text(memes[i % memes.length], x, y);
            }
        }
        
        function drawExit() {
            let pulse = sin(frameCount * 0.1) * 5;
            let allDefeated = npcs.filter(n => !n.defeated).length === 0;
            
            push();
            translate(exit.x + TILE_SIZE/2, exit.y + TILE_SIZE/2);
            
            // Glow
            if (allDefeated) {
                fill(0, 255, 100, 50 + sin(frameCount * 0.2) * 30);
                noStroke();
                ellipse(0, 0, 80 + pulse, 80 + pulse);
            }
            
            // Door
            fill(allDefeated ? color(50, 200, 100) : color(100, 100, 100));
            stroke(0);
            strokeWeight(3);
            rect(-20, -25, 40, 50, 5);
            
            // Doorknob
            fill(allDefeated ? 255 : 150);
            ellipse(12, 5, 8, 8);
            
            // EXIT text
            fill(255);
            noStroke();
            textSize(12);
            textAlign(CENTER, CENTER);
            text("EXIT", 0, -35);
            
            if (!allDefeated) {
                fill(255, 100, 100);
                textSize(10);
                text("üîí DEFEAT ALL NPCs", 0, 35);
            }
            
            pop();
        }
        
        function drawUI() {
            // Top bar
            fill(0, 0, 0, 200);
            noStroke();
            rect(0, 0, GAME_WIDTH, 65);
            
            // Level name
            fill(255, 0, 102);
            textSize(20);
            textAlign(LEFT, CENTER);
            text(`LEVEL ${currentLevel + 1}: ${LEVELS[currentLevel]?.name || ''}`, 20, 22);
            
            // Tutorial hint
            fill(150);
            textSize(14);
            text(LEVELS[currentLevel]?.tutorial || '', 20, 48);
            
            // Lives
            fill(255);
            textSize(22);
            textAlign(RIGHT, CENTER);
            let hearts = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
            text(hearts, GAME_WIDTH - 20, 22);
            
            // Sigma level
            fill(0, 255, 255);
            textSize(16);
            text(`SIGMA: ${sigmaLevel}`, GAME_WIDTH - 20, 48);
            
            // Action buttons display
            let actionY = GAME_HEIGHT - 45;
            let actionBoxWidth = 140;
            let startX = GAME_WIDTH/2 - (actionBoxWidth * 1.5 + 20);
            
            // MOG
            drawActionButton(startX, actionY, "1: MOG", color(255, 0, 102), currentAction === 'mog' && actionTimer > 0);
            // IGNORE
            drawActionButton(startX + actionBoxWidth + 10, actionY, "2: IGNORE", color(0, 255, 255), currentAction === 'ignore' && actionTimer > 0);
            // GRIND
            drawActionButton(startX + (actionBoxWidth + 10) * 2, actionY, "3: GRIND", color(255, 170, 0), currentAction === 'grind' && actionTimer > 0);
            
            // NPC counter
            let remaining = npcs.filter(n => !n.defeated).length;
            fill(255);
            textSize(16);
            textAlign(CENTER, CENTER);
            text(`NPCs: ${remaining}`, GAME_WIDTH/2, 22);
        }
        
        function drawActionButton(x, y, label, col, active) {
            push();
            if (active) {
                fill(red(col), green(col), blue(col), 50);
                stroke(col);
                strokeWeight(3);
            } else {
                fill(0, 0, 0, 150);
                stroke(red(col), green(col), blue(col), 150);
                strokeWeight(2);
            }
            rect(x, y, 130, 35, 8);
            
            fill(active ? 255 : color(red(col), green(col), blue(col)));
            noStroke();
            textSize(16);
            textAlign(CENTER, CENTER);
            text(label, x + 65, y + 17);
            pop();
        }
        
        // ===== INPUT HANDLERS =====
        function keyPressed() {
            if (gameState !== 'playing') {
                if (key === ' ' && gameState === 'paused') {
                    gameState = 'playing';
                    document.getElementById('overlay').classList.add('hidden');
                }
                return;
            }
            
            // Actions
            if (key === '1') {
                currentAction = 'mog';
                actionTimer = 45;
                screenShake = 3;
                floatingTexts.push(new FloatingText(player.x + player.size/2, player.y - 20, 
                    "üóø MOG!", color(255, 0, 102), 22));
            }
            if (key === '2') {
                currentAction = 'ignore';
                actionTimer = 45;
                floatingTexts.push(new FloatingText(player.x + player.size/2, player.y - 20, 
                    "üòê IGNORE", color(0, 255, 255), 22));
            }
            if (key === '3') {
                currentAction = 'grind';
                actionTimer = 45;
                screenShake = 2;
                floatingTexts.push(new FloatingText(player.x + player.size/2, player.y - 20, 
                    "üí™ GRIND!", color(255, 170, 0), 22));
            }
        }
        
        // Prevent arrow key scrolling
        window.addEventListener('keydown', function(e) {
            if ([32, 37, 38, 39, 40].includes(e.keyCode)) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
